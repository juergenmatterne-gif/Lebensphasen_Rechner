<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lebensphasen-Rechner (PKV/GKV) – V8e</title>
<style>
  :root {
    --bg:#f3f4f8;
    --panel:#ffffff;
    --ink:#0f172a;
    --muted:#6b7280;
    --border:#e5e7eb;
    --blue:#1d4ed8;
    --blue-soft:#dbeafe;
    --blue-deep:#1e40af;
    --red:#dc2626;
    --red-soft:#fee2e2;
    --red-deep:#b91c1c;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  body{margin:0;background:var(--bg);color:var(--ink)}
  header{
    padding:16px 18px;
    background:linear-gradient(90deg,#e0ecff,#eef2ff);
    border-bottom:1px solid var(--border);
  }
  header h1{margin:0;font-size:20px;font-weight:800}
  header p{margin:4px 0 0;color:#475569;font-size:12px}
  header a{color:#1d4ed8;text-decoration:none}
  header a:hover{text-decoration:underline}

  main{
    display:grid;
    grid-template-columns:1.12fr 1fr;
    gap:14px;
    padding:14px;
  }
  @media(max-width:1050px){
    main{grid-template-columns:1fr}
  }

  .card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:14px;
    padding:12px;
    box-shadow:0 4px 14px rgba(15,23,42,0.06);
  }
  h2{font-size:16px;margin:0 0 10px 0}

  label{display:block;font-size:12px;color:#334155;margin:6px 0 4px}
  input,select{
    width:100%;
    padding:9px 10px;
    border:1px solid var(--border);
    border-radius:10px;
    background:#fbfdff;
    color:#0f172a;
    font-size:13px;
  }
  input:focus,select:focus{
    outline:none;
    border-color:#2563eb;
    box-shadow:0 0 0 1px rgba(37,99,235,0.15);
  }
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
  @media(max-width:900px){
    .grid-3,.grid-4{grid-template-columns:1fr 1fr}
  }

  .inline{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btn{
    background:var(--blue);
    border:0;border-radius:10px;
    color:#fff;
    padding:9px 14px;
    font-size:13px;
    cursor:pointer;
  }
  .btn.ghost{
    background:#eef2ff;
    color:#1e3a8a;
    border:1px solid #c7d2fe;
  }
  .btn.warn{background:#f97373}
  .btn:hover{filter:brightness(1.03)}

  .hint{font-size:11px;color:var(--muted);line-height:1.25}

  /* Beschäftigung optisch hervorheben */
  .employment-wrapper select{
    background:#eef2ff;
    border-color:#bfdbfe;
    color:#1e40af;
    font-weight:600;
  }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    background:#ffffff;
    border-radius:10px;
    overflow:hidden;
  }
  th,td{
    padding:6px 8px;
    border-bottom:1px solid var(--border);
    text-align:right;
    font-variant-numeric:tabular-nums;
    font-size:11px;
  }
  th:first-child,td:first-child{text-align:left}
  thead th{
    background:#eef2ff;
    color:#1e3a8a;
    position:sticky;
    top:0;
    z-index:1;
  }

  .result-grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
  .result-box{
    border-radius:12px;
    padding:10px 12px;
    border:1px solid var(--border);
    background:#f9fafb;
  }
  .result-box.pkv{
    background:var(--blue-soft);
    border-color:#bfdbfe;
  }
  .result-box.gkv{
    background:var(--red-soft);
    border-color:#fecaca;
  }
  .result-label{font-size:11px;color:#4b5563;margin-bottom:2px}
  .result-value{font-size:18px;font-weight:800;margin:0}
  .result-tag{font-size:11px;font-weight:700}

  canvas{
    width:100%;
    height:260px;
    background:#f1f5f9;
    border:1px solid #d0d7e2;
    border-radius:12px;
  }
  #chart2{height:220px}

  details>summary{cursor:pointer;list-style:none}
  details>summary::-webkit-details-marker{display:none}
  .chip{
    display:inline-block;
    padding:3px 8px;
    border-radius:999px;
    background:#eef2ff;
    border:1px solid #c7d2fe;
    font-size:11px;
    color:#1e3a8a;
  }

  footer{
    padding:8px 14px 14px;
    text-align:center;
    color:#475569;
    font-size:11px;
  }
  #err{
    display:none;
    white-space:pre-wrap;
    background:#fff5f5;
    border:1px solid #fecaca;
    color:#7f1d1d;
    padding:10px;
    border-radius:10px;
    margin:10px 0;
    font-size:11px;
  }

  .disclaimer{
    margin-top:8px;
    font-size:10px;
    color:#6b7280;
    text-align:left;
  }
</style>
</head>
<body>
<header>
  <h1>Lebensphasen-Rechner (PKV/GKV) – V8e</h1>
  <p>Jürgen Matterne, Versicherungsfachwirt – 
     <a href="mailto:Juergen.Matterne@vk-makler.de">Juergen.Matterne@vk-makler.de</a></p>
</header>

<main>
  <!-- LINKER BLOCK: EINGABEN -->
  <section class="card">
    <h2>1) Eingaben</h2>
    <div id="err"></div>

    <div class="grid-3">
      <div>
        <label>Versicherungsbeginn (Monat/Jahr)</label>
        <input id="startYM" type="month" value="2026-01">
      </div>
      <div class="employment-wrapper">
        <label>Beschäftigung</label>
        <select id="employment">
          <option value="angestellt" selected>Angestellt (mit AG-Zuschuss)</option>
          <option value="selbst">Selbstständig (ohne AG-Zuschuss)</option>
        </select>
      </div>
      <div>
        <label>Grenzsteuersatz (%)</label>
        <input id="taxPct" type="number" step="0.1" value="">
      </div>
    </div>

    <div class="grid-3">
      <div>
        <label>Absetzbarer Anteil PKV <em>ca.</em> (%)</label>
        <input id="deduct" type="number" step="0.1" value="">
      </div>
      <div>
        <label>PKV-Steigerung bis 67 (%)</label>
        <input id="incPKV" type="number" step="0.01" value="3.5">
      </div>
      <div>
        <label>GKV-Steigerung bis 67 (%)</label>
        <input id="incGKV" type="number" step="0.01" value="3.5">
      </div>
    </div>

    <!-- Person 1 -->
    <details class="card" open>
      <summary><span class="chip">Person 1</span></summary>
      <div class="grid-3">
        <div>
          <label>Geburtsjahr</label>
          <input id="p1_year" type="number" value="1996">
        </div>
        <div>
          <label>PKV Start (€/Monat)</label>
          <input id="p1_pkv" type="number" step="0.01" value="800">
        </div>
      </div>
    </details>

    <!-- Person 2–5 -->
    <details class="card" id="secP2">
      <summary><span class="chip">Person 2</span></summary>
      <div class="grid-4">
        <div><label>Geburtsjahr</label><input id="p2_year" type="number" value=""></div>
        <div><label>Eintrittsdatum (Monat/Jahr)</label><input id="p2_joinYear" type="number" value=""></div>
        <div><label>PKV bei Eintritt (€/Monat)</label><input id="p2_pkv" type="number" step="0.01" value="0"></div>
        <div><label>Dauer (Jahre)</label><input id="p2_dur" type="number" value="0"></div>
      </div>
    </details>

    <details class="card" id="secP3">
      <summary><span class="chip">Person 3</span></summary>
      <div class="grid-4">
        <div><label>Geburtsjahr</label><input id="p3_year" type="number" value=""></div>
        <div><label>Eintrittsdatum (Monat/Jahr)</label><input id="p3_joinYear" type="number" value=""></div>
        <div><label>PKV bei Eintritt (€/Monat)</label><input id="p3_pkv" type="number" step="0.01" value="0"></div>
        <div><label>Dauer (Jahre)</label><input id="p3_dur" type="number" value="0"></div>
      </div>
    </details>

    <details class="card" id="secP4">
      <summary><span class="chip">Person 4</span></summary>
      <div class="grid-4">
        <div><label>Geburtsjahr</label><input id="p4_year" type="number" value=""></div>
        <div><label>Eintrittsdatum (Monat/Jahr)</label><input id="p4_joinYear" type="number" value=""></div>
        <div><label>PKV bei Eintritt (€/Monat)</label><input id="p4_pkv" type="number" step="0.01" value="0"></div>
        <div><label>Dauer (Jahre)</label><input id="p4_dur" type="number" value="0"></div>
      </div>
    </details>

    <details class="card" id="secP5">
      <summary><span class="chip">Person 5</span></summary>
      <div class="grid-4">
        <div><label>Geburtsjahr</label><input id="p5_year" type="number" value=""></div>
        <div><label>Eintrittsdatum (Monat/Jahr)</label><input id="p5_joinYear" type="number" value=""></div>
        <div><label>PKV bei Eintritt (€/Monat)</label><input id="p5_pkv" type="number" step="0.01" value="0"></div>
        <div><label>Dauer (Jahre)</label><input id="p5_dur" type="number" value="0"></div>
      </div>
    </details>

    <!-- GKV Parameter -->
    <details class="card" open>
      <summary><span class="chip">GKV – Parameter & Zusatz</span></summary>
      <div class="grid-3">
        <div><label>BBG Monat (€, Start)</label><input id="bbg" type="number" step="0.01" value="5812.50"></div>
        <div><label>AG-Zuschuss MAX KV (€/Monat, Start)</label><input id="capKV" type="number" value="508.59"></div>
        <div><label>AG-Zuschuss MAX Pflege (€/Monat, Start)</label><input id="capPV" type="number" value="104.63"></div>
      </div>
      <div class="grid-4">
        <div><label>KV-Satz (%)</label><input id="kv" type="number" step="0.01" value="14.6"></div>
        <div><label>Zusatzbeitrag KV (%)</label><input id="kvz" type="number" step="0.01" value="3.5"></div>
        <div><label>Pflege-Satz (%)</label><input id="pv" type="number" step="0.01" value="3.6"></div>
        <div><label>Zusatz Pflege (%)</label><input id="pvz" type="number" step="0.01" value="0.6"></div>
      </div>
      <div class="grid-4">
        <div><label>Zusatz Ambulant (€/Monat)</label><input id="supp_amb" type="number" step="0.01" value="0"></div>
        <div><label>Zusatz Stationär (€/Monat)</label><input id="supp_stat" type="number" step="0.01" value="0"></div>
        <div><label>Zusatz Zahn (€/Monat)</label><input id="supp_zahn" type="number" step="0.01" value="0"></div>
        <div><label>Krankentagegeld (€/Monat)</label><input id="supp_ktg" type="number" step="0.01" value="0"></div>
      </div>
      <div class="hint">
        GKV-Grundbeitrag (KV + Pflege) steuerlich zu 100 % ansetzbar. Zusatzversicherungen nicht.
      </div>
    </details>

    <!-- Beitragsentlastung / Phase 67–85 -->
    <details class="card" open>
      <summary><span class="chip">Beitragsentlastung ab 65 Jahre & Phase 67–85</span></summary>
      <div class="grid-3">
        <div><label>Garantierte Entlastung ab 65 (€/Monat)</label><input id="entl_amt" type="number" step="0.01" value="0"></div>
        <div><label>Beitrag Entlastung (€/Monat) – AG-zuschussfähig</label><input id="entl_prem" type="number" step="0.01" value="0"></div>
        <div><label>BAP-Prognose 67–85 (%)</label><input id="entl_bap" type="number" step="0.1" value="0.5"></div>
      </div>
      <div class="grid-3">
        <div><label>PKV ab 67 (€/Monat – Start 67)</label><input id="pkv67" type="number" step="0.01" value="800"></div>
        <div><label>Renten-Zuschuss (€/Monat)</label><input id="rentSub" type="number" step="0.01" value="326"></div>
        <div><label>GKV 67–85 (€/Monat – Start 67)</label><input id="gkv6785" type="number" step="0.01" value="486"></div>
      </div>
    </details>

    <div class="inline">
      <button class="btn" id="btnCalc">Berechnen</button>
      <button class="btn ghost" id="btnPrint">Drucken / PDF</button>
      <button class="btn warn" id="btnReset">Zurücksetzen</button>
    </div>
  </section>

  <!-- RECHTER BLOCK: ERGEBNIS + GRAFIKEN -->
  <section class="card">
    <h2>2) Ergebnisse</h2>

    <div class="result-grid">
      <div class="result-box pkv">
        <div class="result-label">
          <span class="result-tag" style="color:var(--blue-deep)">PKV</span> – Ergebnis 1: bis 67 (nach Steuer)
        </div>
        <p class="result-value" id="sumPKV">–</p>
      </div>
      <div class="result-box gkv">
        <div class="result-label">
          <span class="result-tag" style="color:var(--red-deep)">GKV</span> – Ergebnis 1: bis 67 (Netto)
        </div>
        <p class="result-value" id="sumGKV">–</p>
      </div>
    </div>

    <div class="result-grid" style="margin-top:10px">
      <div class="result-box pkv">
        <div class="result-label">
          <span class="result-tag" style="color:var(--blue-deep)">PKV</span> – Ergebnis 2: 67–85 (netto, mit Wachstum)
        </div>
        <p class="result-value" id="sumPKV6785">–</p>
      </div>
      <div class="result-box gkv">
        <div class="result-label">
          <span class="result-tag" style="color:var(--red-deep)">GKV</span> – Ergebnis 2: 67–85 (mit Wachstum)
        </div>
        <p class="result-value" id="sumGKV6785">–</p>
      </div>
    </div>

    <div style="margin-top:12px">
      <canvas id="chart1" width="640" height="260"></canvas>
    </div>
    <div style="margin-top:12px">
      <canvas id="chart2" width="640" height="220"></canvas>
    </div>

    <div class="disclaimer">
      Es wurde Sorgfalt verwandt. Eine Garantie kann nicht übernommen werden.
    </div>

    <div id="tableWrap" style="max-height:48vh;overflow:auto;margin-top:12px">
      <table id="tbl">
        <thead>
          <tr>
            <th>Jahr</th>
            <th>Alter P1</th>
            <th>PKV/Jahr (nach Steuer)</th>
            <th>GKV/Jahr (Netto)</th>
            <th>Diff/Jahr</th>
            <th>P1</th><th>P2</th><th>P3</th><th>P4</th><th>P5</th>
            <th>Entl.-Beitrag</th>
            <th>AG-Zuschuss</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<footer>
  © <span id="yearNow"></span> Jürgen Matterne, Versicherungsfachwirt – Es wurde Sorgfalt verwandt. Eine Garantie kann nicht übernommen werden.
</footer>

<script>
function euro(n){return(isFinite(n)?n:0).toLocaleString('de-DE',{style:'currency',currency:'EUR'});}
function grow(v,p,yrs){return v*Math.pow(1+p/100,yrs);}
function GN(id,def=0){const el=document.getElementById(id);const v=parseFloat(el.value);return isNaN(v)?def:v;}

function compute(){
  const incPKV=GN('incPKV',3.5),incGKV=GN('incGKV',3.5);
  const taxPct=GN('taxPct',0),deduct=GN('deduct',0);
  const emp=document.getElementById('employment').value;

  const capKV0=GN('capKV',508.59),capPV0=GN('capPV',104.63);
  const bbg0=GN('bbg',5812.50);
  const kv=GN('kv',14.6),kvz=GN('kvz',3.5),pv=GN('pv',3.6),pvz=GN('pvz',0.6);

  const p1_pkv=GN('p1_pkv',800);
  const p2_pkv=GN('p2_pkv',0),p2_joinYear=GN('p2_joinYear',0),p2_dur=GN('p2_dur',0);
  const p3_pkv=GN('p3_pkv',0),p3_joinYear=GN('p3_joinYear',0),p3_dur=GN('p3_dur',0);
  const p4_pkv=GN('p4_pkv',0),p4_joinYear=GN('p4_joinYear',0),p4_dur=GN('p4_dur',0);
  const p5_pkv=GN('p5_pkv',0),p5_joinYear=GN('p5_joinYear',0),p5_dur=GN('p5_dur',0);

  const startYear=parseInt((document.getElementById('startYM').value||'2026-01').split('-')[0])||2026;
  const p1_year=GN('p1_year',startYear-30);
  const ageStart=Math.max(0,Math.min(90,startYear-p1_year));
  const years=Math.max(0,67-ageStart);
  function rel(yAbs){return Math.max(0,yAbs-startYear);}

  const supp0=GN('supp_amb',0)+GN('supp_stat',0)+GN('supp_zahn',0)+GN('supp_ktg',0);

  const entl_amt=GN('entl_amt',0),entl_prem0=GN('entl_prem',0),entl_bap=GN('entl_bap',0.5);

  const rows=[];
  let sumPKV=0,sumGKV=0,cumPKV=0,cumGKV=0;

  for(let y=0;y<=years;y++){
    const age=ageStart+y;

    let p1=grow(p1_pkv,incPKV,y);
    function member(joinYear,prem0,dur){
      if(!joinYear||prem0<=0||dur<=0)return 0;
      const ry=rel(joinYear);
      if(y<ry||y>=ry+dur)return 0;
      return grow(prem0,incPKV,y-ry);
    }
    let p2=member(p2_joinYear,p2_pkv,p2_dur);
    let p3=member(p3_joinYear,p3_pkv,p3_dur);
    let p4=member(p4_joinYear,p4_pkv,p4_dur);
    let p5=member(p5_joinYear,p5_pkv,p5_dur);

    let entlPrem=grow(entl_prem0,entl_bap,y);
    let pkvMonthGross=p1+p2+p3+p4+p5+entlPrem;
    if(age>=65)pkvMonthGross=Math.max(0,pkvMonthGross-entl_amt);

    let capKVy=grow(capKV0,incGKV,y);
    let agPKV=0;
    if(emp==='angestellt'){agPKV=Math.min(0.5*pkvMonthGross,capKVy);}
    const employeePKV=Math.max(0,pkvMonthGross-agPKV);
    const taxSavePKV=employeePKV*(deduct/100)*(taxPct/100);
    const pkvYear=Math.max(0,employeePKV-taxSavePKV)*12;
    sumPKV+=pkvYear;cumPKV+=pkvYear;

    const bbgY=grow(bbg0,incGKV,y);
    const kv_partY=bbgY*((kv+kvz)/100);
    const pv_partY=bbgY*((pv+pvz)/100);
    let capKVgy=grow(capKV0,incGKV,y),capPVgy=grow(capPV0,incGKV,y);
    let agKV=0,agPV=0;
    if(emp==='angestellt'){
      agKV=Math.min(0.5*kv_partY,capKVgy);
      agPV=Math.min(0.5*pv_partY,capPVgy);
    }
    const employeeBase=(kv_partY-agKV)+(pv_partY-agPV);
    const taxSaveGKV=employeeBase*(taxPct/100);
    const suppY=grow(supp0,incGKV,y);
    const gkvYear=(Math.max(0,employeeBase-taxSaveGKV)+suppY)*12;
    sumGKV+=gkvYear;cumGKV+=gkvYear;

    rows.push({
      y,age,pkvYear,gkvYear,diff:pkvYear-gkvYear,
      p1,p2,p3,p4,p5,entlPrem,ag:agPKV+agKV+agPV,
      cumPKV,cumGKV
    });
  }

  const pkv67=GN('pkv67',800),rentSub=GN('rentSub',326),gkv6785=GN('gkv6785',486);
  let sumPKV6785=0,sumGKV6785=0;
  const phaseYears=18; // 67–85
  for(let i=0;i<phaseYears;i++){
    const pkv_t=grow(pkv67,entl_bap,i);
    const entl_t=grow(entl_prem0,entl_bap,years+i);
    const gkv_t=grow(gkv6785,entl_bap,i);
    let pkvMonthly=Math.max(0,pkv_t+entl_t-rentSub-entl_amt);
    sumPKV6785+=pkvMonthly*12;
    sumGKV6785+=gkv_t*12;
  }

  return {rows,sumPKV,sumGKV,sumPKV6785,sumGKV6785};
}

/* --- Diagramme: dunkler, kontrastreich, Legende kleiner --- */
function drawChart1(rows){
  const c=document.getElementById('chart1'),ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const pad=36,w=c.width-pad*2,h=c.height-pad*2;
  const ys1=rows.map(r=>r.cumPKV||0),ys2=rows.map(r=>r.cumGKV||0);
  const ymax=Math.max(1,Math.max(...ys1,...ys2)*1.05);

  // Hintergrund & Achsen
  ctx.fillStyle='#e5e7eb';
  ctx.fillRect(pad-1,pad-1,w+2,h+2);

  ctx.strokeStyle='#cbd5e1';
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(pad,pad);
  ctx.lineTo(pad,pad+h);
  ctx.lineTo(pad+w,pad+h);
  ctx.stroke();

  ctx.font='11px system-ui';
  ctx.fillStyle='#475569';
  const steps=5;
  for(let i=0;i<=steps;i++){
    const y=pad+h-i*h/steps;
    const v=ymax*i/steps;
    ctx.fillText(euro(v),6,y+4);
    ctx.strokeStyle='#d9e2f2';
    ctx.beginPath();
    ctx.moveTo(pad,y);
    ctx.lineTo(pad+w,y);
    ctx.stroke();
  }

  function plot(ys,color1,color2){
    const grd=ctx.createLinearGradient(pad,pad,pad+w,pad+h);
    grd.addColorStop(0,color1);
    grd.addColorStop(1,color2);
    ctx.strokeStyle=grd;
    ctx.lineWidth=3;
    ctx.beginPath();
    ys.forEach((v,i)=>{
      const x=pad+w*(i/Math.max(1,ys.length-1));
      const y=pad+h-(v/ymax)*h;
      if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);
    });
    ctx.stroke();
  }

  // PKV blau, GKV rot
  plot(ys1,'#2563eb','#1e40af');
  plot(ys2,'#f97373','#b91c1c');

  // kleine Legende unten rechts
  ctx.font='11px system-ui';
  const legendY=pad+h+24;
  ctx.fillStyle='#2563eb';
  ctx.fillRect(pad+140,legendY-10,10,10);
  ctx.fillStyle='#475569';
  ctx.fillText('PKV kumuliert (bis 67)',pad+155,legendY);
  ctx.fillStyle='#ef4444';
  ctx.fillRect(pad+320,legendY-10,10,10);
  ctx.fillStyle='#475569';
  ctx.fillText('GKV kumuliert (bis 67)',pad+335,legendY);
}

function drawChart2(sumPKV,sumGKV){
  const c=document.getElementById('chart2'),ctx=c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const pad=40,w=c.width-pad*2,h=c.height-pad*2;
  const ymax=Math.max(sumPKV,sumGKV)*1.2||1;

  ctx.fillStyle='#e5e7eb';
  ctx.fillRect(pad-1,pad-1,w+2,h+2);

  ctx.strokeStyle='#cbd5e1';
  ctx.beginPath();
  ctx.moveTo(pad,pad);
  ctx.lineTo(pad,pad+h);
  ctx.lineTo(pad+w,pad+h);
  ctx.stroke();

  function bar(x,val,label,color1,color2){
    const bw=80,x0=pad+x;
    const y=pad+h-(val/ymax)*h;
    const grd=ctx.createLinearGradient(x0,pad,x0,pad+h);
    grd.addColorStop(0,color1);
    grd.addColorStop(1,color2);
    ctx.fillStyle=grd;
    ctx.fillRect(x0,y,bw,pad+h-y);
    ctx.fillStyle='#334155';
    ctx.font='11px system-ui';
    ctx.fillText(label,x0,pad+h+16);
    ctx.fillText(euro(val),x0,y-6);
  }

  bar(40,sumPKV,'PKV 67–85','#2563eb','#1e40af');
  bar(180,sumGKV,'GKV 67–85','#f97373','#b91c1c');
}

function render(){
  try{
    const res=compute();
    document.getElementById('sumPKV').textContent=euro(res.sumPKV);
    document.getElementById('sumGKV').textContent=euro(res.sumGKV);
    document.getElementById('sumPKV6785').textContent=euro(res.sumPKV6785);
    document.getElementById('sumGKV6785').textContent=euro(res.sumGKV6785);

    const tb=document.querySelector('#tbl tbody');tb.innerHTML='';
    res.rows.forEach(r=>{
      const tr=document.createElement('tr');
      function cell(t,cls){const td=document.createElement('td');td.textContent=t;if(cls)td.className=cls;tr.appendChild(td);}
      cell(String(r.y));
      cell(String(r.age));
      cell(euro(r.pkvYear));
      cell(euro(r.gkvYear));
      cell(euro(r.diff),r.diff>0?'bad':'ok');
      cell(euro(r.p1));
      cell(euro(r.p2));
      cell(euro(r.p3));
      cell(euro(r.p4));
      cell(euro(r.p5));
      cell(euro(r.entlPrem));
      cell(euro(r.ag));
      tb.appendChild(tr);
    });

    drawChart1(res.rows);
    drawChart2(res.sumPKV6785,res.sumGKV6785);
    document.getElementById('err').style.display='none';
  }catch(e){
    const box=document.getElementById('err');
    box.textContent='Fehler: '+e.message+'\n'+(e.stack||'');
    box.style.display='block';
  }
}

function resetDefaults(){
  const set=(id,val)=>{const el=document.getElementById(id);if(el)el.value=val;};
  set('startYM','2026-01');
  set('employment','angestellt');
  set('taxPct','');
  set('deduct','');
  set('incPKV','3.5');
  set('incGKV','3.5');

  set('p1_year','1996');set('p1_pkv','800');

  ['2','3','4','5'].forEach(n=>{
    set('p'+n+'_year','');
    set('p'+n+'_joinYear','');
    set('p'+n+'_pkv','0');
    set('p'+n+'_dur','0');
  });

  set('bbg','5812.50');
  set('capKV','508.59');
  set('capPV','104.63');
  set('kv','14.6');set('kvz','3.5');set('pv','3.6');set('pvz','0.6');
  set('supp_amb','0');set('supp_stat','0');set('supp_zahn','0');set('supp_ktg','0');

  set('entl_amt','0');set('entl_prem','0');set('entl_bap','0.5');
  set('pkv67','800');set('rentSub','326');set('gkv6785','486');

  ['secP2','secP3','secP4','secP5'].forEach(id=>{
    const d=document.getElementById(id);
    if(d)d.open=false;
  });
}

function autoToggle(sectionId,inputIds){
  const sec=document.getElementById(sectionId);
  function check(){
    let open=false;
    inputIds.forEach(id=>{
      const el=document.getElementById(id);
      if(el && parseFloat(el.value)>0)open=true;
    });
    sec.open=open;
  }
  inputIds.forEach(id=>{
    const el=document.getElementById(id);
    if(el)el.addEventListener('input',check);
  });
  check();
}

document.getElementById('btnCalc').addEventListener('click',render);
document.getElementById('btnPrint').addEventListener('click',()=>window.print());
document.getElementById('btnReset').addEventListener('click',()=>{resetDefaults();});
window.addEventListener('DOMContentLoaded',()=>{
  resetDefaults();
  autoToggle('secP2',['p2_pkv','p2_dur']);
  autoToggle('secP3',['p3_pkv','p3_dur']);
  autoToggle('secP4',['p4_pkv','p4_dur']);
  autoToggle('secP5',['p5_pkv','p5_dur']);
  document.getElementById('yearNow').textContent=new Date().getFullYear();
});
</script>
</body>
</html>
